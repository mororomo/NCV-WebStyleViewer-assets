<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NCV WebStyleViewr</title>
<style>
    #indicator {
        background-color: #727272;
        border: none;
        border-radius: 4px;
        bottom: 8px;
        cursor: pointer;
        display: block;
        filter: drop-shadow(0 0 3px rgba(0,0,0,.3));
        height: 32px;
        left: 50%;
        opacity: .7;
        outline: none;
        padding: 0;
        position: fixed;
        transition: opacity .2s ease;
        width: 32px;
        will-change: opacity,bottom;
    }
    #indicator:hover {
        opacity: 1;
    }
    #indicator:before {
        background-color: #f4f4f4;
        content: "";
        display: inline-block;
        height: 32px;
        -webkit-mask-image: url(./img/down_button.svg);
        -webkit-mask-position: center;
        -webkit-mask-repeat: no-repeat;
        -webkit-mask-size: contain;
        pointer-events: none;
        width: 32px;
    }
    .chat {
        display: flex;
    }
    .chat span {
        display: inline-block;
        margin: auto 0;
    }
    .chat-number {
        font-size: 0.5em;
        text-align: right;
    }
    .chat-comment {
        width: 50%;
    }
    .chat-userid {
        min-width: 100px;
    }
    .chat-userid {
        min-width: 100px;
    }
    .server-comment {
        color: #f03;
    }
</style>
</head>
<body>
<div id="comment-panel"></div>
<script type="text/javascript">
/* ※必須※（中身は書き換え自由）
 * NCV本体からコメント追加の度に呼ばれる
 * comment.html で指定された各項目が置換されて丸ごとコメント一つ分のhtmlタグとして渡される
 */
function addNewComment(comment) {
  document.getElementById('comment-panel').insertAdjacentHTML('beforeend', comment);
}

function scrollBottom() {
  window.scrollTo(0, document.body.scrollHeight);
}

function isDownButtonVisible() {
  return document.getElementById("indicator") !== null;
}

const commentPanel = document.getElementById('comment-panel');
const mo = new MutationObserver(function() {
  if (!isDownButtonVisible()) {
    scrollBottom();
  }
  const lastComment = commentPanel.lastElementChild;
  if (lastComment.dataset.anon === "1") {
    let elm = document.createElement('span');
    elm.textContent = "※匿名※";
    lastComment.appendChild(elm);
  }
  if (lastComment.dataset.premium === "1") {
    let elm = document.createElement('span');
    elm.textContent = "P";
    lastComment.appendChild(elm);
  }
  if (lastComment.dataset.server === "1") {
    lastComment.querySelector('.chat-comment').classList.add('server-comment');
    let elm = document.createElement('span');
    elm.textContent = "※運営※";
    lastComment.appendChild(elm);
  }
  if (lastComment.dataset.emotion === "1") {
    let elm = document.createElement('span');
    elm.textContent = "E";
    lastComment.appendChild(elm);
  }
});
mo.observe(commentPanel, { childList: true });

const btn = document.createElement('button');
btn.id = "indicator";
btn.type = "button";
btn.ariaLabel = "最新コメントに戻る";
btn.onclick = scrollBottom;

function downButtonState() {
  const lastComment = commentPanel.lastElementChild;
  const rect = lastComment.getBoundingClientRect();
  const isDisplay = 0 < rect.bottom && rect.top < window.innerHeight;
  if (isDisplay) {
    if (isDownButtonVisible()) { btn.remove(); }
  }
  else {
    if (!isDownButtonVisible()) { commentPanel.after(btn); }
  }
};

let ticking = false;
document.addEventListener("scroll", (event) => {
  if (!ticking) {
    window.requestAnimationFrame(() => {
      downButtonState();
      ticking = false;
    });
    ticking = true;
  }
});
</script>
</body>
</html>